<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INTRUSION</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        :root {
            /* DARK THEME (DEFAULT) */
            --bg-grad-1: #020617; --bg-grad-2: #1e1b4b; --bg-grad-3: #310b1e; --bg-grad-4: #0f172a;
            --card-bg: rgba(15, 23, 42, 0.85);
            --primary-neon: #38bdf8;
            --danger-neon: #f43f5e;
            --accent-neon: #fbbf24;
            --grey-neon: #94a3b8;
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --input-bg: #000000;
            --input-text: #ffffff;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        /* LIGHT THEME OVERRIDES */
        body.light-mode {
            --bg-grad-1: #f0f9ff; --bg-grad-2: #e0f2fe; --bg-grad-3: #fce7f3; --bg-grad-4: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.85);
            --primary-neon: #0284c7;
            --danger-neon: #e11d48;
            --accent-neon: #d97706;
            --grey-neon: #64748b;
            --text-main: #0f172a;
            --text-muted: #475569;
            --input-bg: #ffffff;
            --input-text: #0f172a;
            --border-color: rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2), var(--bg-grad-3), var(--bg-grad-4));
            background-size: 400% 400%;
            animation: cyberWave 15s ease infinite;
            color: var(--text-main);
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: color 0.3s, background 0.3s;
        }

        @keyframes cyberWave {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        h1, h2, h3, h4, .brand-font {
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 2px;
            color: var(--text-main);
        }

        body.light-mode .text-white, 
        body.light-mode .text-light { color: #0f172a !important; }
        body.light-mode .text-white-force { color: #0f172a !important; }

        label, .form-label { color: var(--text-main) !important; font-weight: 500; opacity: 1 !important; }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, background 0.3s;
        }

        /* --- INPUTS --- */
        .cyber-input-group {
            display: flex; border-radius: 12px; overflow: hidden;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); border: 1px solid var(--primary-neon);
        }
        .cyber-label {
            background-color: var(--primary-neon); color: #fff; font-family: 'Orbitron', sans-serif;
            font-weight: 800; padding: 0 15px; display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; text-transform: uppercase; min-width: 90px;
        }
        .cyber-input {
            background-color: var(--input-bg); color: var(--input-text) !important; caret-color: var(--primary-neon);
            border: none; padding: 15px; font-family: 'Poppins', sans-serif; font-weight: bold;
            font-size: 1.2rem; width: 100%; outline: none;
        }
        
        /* --- STATS BOXES --- */
        .stat-box {
            background: rgba(125, 125, 125, 0.1); border: 2px solid var(--border-color); border-radius: 15px; padding: 10px 5px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100px;
            transition: all 0.2s; backdrop-filter: blur(5px);
        }
        .stat-box:active { transform: scale(0.95); }
        .box-infiltre { border-color: var(--danger-neon); }
        .box-infiltre .role-name { color: var(--danger-neon); }
        .box-inconnu { border-color: var(--grey-neon); }
        .box-inconnu .role-name { color: var(--grey-neon); }
        .box-pnj { border-color: var(--primary-neon); }
        .box-pnj .role-name { color: var(--primary-neon); }
        .role-name { font-family: 'Orbitron', sans-serif; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .role-count { font-size: 1.8rem; font-weight: 700; color: var(--text-main); line-height: 1; }

        /* --- CONTROLS --- */
        .ctrl-btn {
            width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; font-weight: bold; font-family: 'Courier New', monospace; cursor: pointer; transition: 0.1s;
        }
        .ctrl-minus { border: 1px solid var(--danger-neon); color: var(--danger-neon); background: transparent; }
        .ctrl-plus { border: 1px solid var(--primary-neon); color: var(--primary-neon); background: transparent; }
        .ctrl-btn:active { background: rgba(125,125,125,0.2); transform: scale(0.9); }
        .ctrl-btn.disabled { opacity: 0.3; cursor: not-allowed; border-color: #555; color: #555; }

        /* --- BUTTONS --- */
        .btn { transition: all 0.1s ease-in-out; }
        .btn:active { transform: scale(0.96); }
        .btn-neon {
            background: linear-gradient(45deg, var(--primary-neon), #3b82f6); border: none; color: #fff;
            font-weight: 700; font-family: 'Orbitron', sans-serif; text-transform: uppercase;
            padding: 12px 20px; border-radius: 12px; box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
        }
        .btn-stop {
            background: rgba(125, 125, 125, 0.1); border: 1px solid var(--danger-neon); color: var(--danger-neon);
            font-family: 'Orbitron', sans-serif; font-weight: bold; padding: 15px 20px; border-radius: 12px;
        }
        .btn-history {
             background: rgba(125, 125, 125, 0.1); border: 1px solid var(--primary-neon); color: var(--primary-neon);
             border-radius: 12px; padding: 0 20px; font-size: 1.5rem; transition: 0.3s;
        }
        .btn-history:active { background: var(--primary-neon); color: white; }
        
        .roster-item {
            background: rgba(125, 125, 125, 0.05); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px 15px;
            border-radius: 12px; display: flex; align-items: center; gap: 15px; margin-bottom: 10px;
        }
        .stat-badge { font-size: 0.7rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        
        .btn-quit {
            position: fixed; top: 15px; left: 15px; z-index: 100;
            background: rgba(0,0,0,0.4); border: 1px solid var(--danger-neon); color: var(--danger-neon);
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; transition: all 0.3s; backdrop-filter: blur(4px);
        }
        .btn-quit:active { background: var(--danger-neon); color: white; transform: scale(0.9); }

        /* --- CORRECTION BUG SCROLL --- */
        .history-scroll-container {
            overflow-y: auto;
            flex-grow: 1;
            min-height: 0;
            margin-bottom: 15px;
            padding-right: 5px;
        }
        .history-scroll-container::-webkit-scrollbar { width: 6px; }
        .history-scroll-container::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }
        .history-scroll-container::-webkit-scrollbar-thumb { background: var(--primary-neon); border-radius: 3px; }

        .history-item {
            background: rgba(125, 125, 125, 0.1); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px 15px;
            border-radius: 12px; cursor: pointer; text-align: left; transition: 0.2s; position: relative;
            user-select: none; margin-bottom: 10px; margin-top: 5px; display: flex; align-items: center; gap: 15px;
        }
        .history-item:active { background: rgba(56, 189, 248, 0.2); transform: scale(0.98); }

        .timer-display { font-size: 5rem; font-family: 'Orbitron', sans-serif; font-weight: 900; color: var(--text-main); transition: color 0.3s; }
        @keyframes heartbeat {
            0% { transform: scale(1); } 15% { transform: scale(1.1); } 30% { transform: scale(1); }
            45% { transform: scale(1.1); } 60% { transform: scale(1); } 100% { transform: scale(1); }
        }
        .timer-urgent { color: var(--danger-neon); animation: heartbeat 1s infinite; }
        .eliminated-role { font-size: 2.5rem; font-family: 'Orbitron', sans-serif; font-weight: 900; margin: 20px 0; text-transform: uppercase; }
        
        /* --- ANIMATIONS & TRANSITIONS --- */
        .fade-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .fade-out { animation: fadeOut 0.3s forwards; }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        /* Effet de choc rouge lors de l'√©limination */
        @keyframes shockwave {
            0% { box-shadow: inset 0 0 0 red; background: rgba(255, 0, 0, 0); transform: translate(0, 0); }
            10% { box-shadow: inset 0 0 100px red; background: rgba(255, 0, 0, 0.2); transform: translate(-5px, 5px); }
            20% { transform: translate(5px, -5px); }
            30% { transform: translate(-5px, 5px); }
            40% { transform: translate(5px, -5px); }
            100% { box-shadow: inset 0 0 0 red; background: transparent; transform: translate(0, 0); }
        }
        .elimination-shock { animation: shockwave 0.5s ease-out; }

        #inputGuessWord {
            color: var(--input-text) !important; background-color: var(--input-bg) !important;
            border: 2px solid var(--accent-neon) !important; font-weight: bold; letter-spacing: 1px; font-family: 'Poppins', sans-serif;
        }

        .btn-check:checked + .btn-outline-secondary { background-color: var(--text-main); color: var(--card-bg); border-color: var(--text-main); }
        .btn-check:not(:checked) + .btn-outline-secondary { color: var(--text-main); border-color: var(--border-color); }
        
        .btn-check:checked + .btn-outline-custom { background-color: var(--primary-neon); color: #fff; border-color: var(--primary-neon); }
        .btn-check:not(:checked) + .btn-outline-custom { color: var(--text-main); border-color: var(--border-color); }
    </style>
</head>
<body class="">

<video id="noSleepVideo" playsinline loop muted class="d-none">
    <source src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAQBAAAACAAAABGdmoQAAABBjbXJhdAAAAAMAAQAAAAAAIHN0Y28AAAAAAAAAAQAAAC50cmFrAAAAXHRraGQAAAADAAAAAQAAAAAAAgAAAAAAWQAAAAEAAAAAAAAAAQAAAAAAAAAAAABmdGlhAAAAAAAUAAAEAQAAAAAAAAABAAAAACRtaW5mAAAAEHNtYWQAAAAAAAAAAAAAAAhkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAFBzdGJsAAAAZHN0c2QAAAAAAAAAAQAAAFRhdmMxAAAAAQAAAAEAAAAAAAEAAAAAAAEAAQAAAAAAAAAAAAAABAEAAAAAAAgAAAAAEWh2Y0MBAAAAAgAAAAMAAAACc3R0cwAAAAAAAAABAAAAAgAAABBzdHN6AAAAAAAAAAEAAAACAAAAKHN0c2MAAAAAAAAAAQAAAAEAAAACAAAAAQAAABBzdGNvAAAAAAAAAAEAAAAsAAAAYdRyYXQAAAAA" type="video/mp4">
</video>

<button id="btn-quit-app" class="btn-quit d-none" onclick="toggleQuitModal(); SFX.click()">
    <i class="bi bi-x-lg"></i>
</button>

<div class="container py-4">
    
    <div class="text-center mb-4 fade-in">
        <h1 class="display-5 fw-bold brand-font">
            <i class="bi bi-incognito"></i> INTRUSION
        </h1>
    </div>

    <div id="view-setup" class="row justify-content-center fade-in">
        <div class="col-md-6">
            <div class="glass-card p-4">
                
                <div class="d-flex justify-content-between mb-4 gap-2">
                    <button onclick="showView('view-roster'); renderFullRoster(); SFX.click()" class="btn btn-outline-custom w-100 py-2 small fw-bold" style="border: 1px solid var(--border-color); color: var(--text-main);">
                        <i class="bi bi-people-fill"></i> LISTE AGENTS
                    </button>
                    
                    <button onclick="toggleTheme(); SFX.click()" id="btnThemeToggle" class="btn btn-outline-custom w-100 py-2 small fw-bold" style="border: 1px solid var(--border-color); color: var(--text-main);">
                        <i class="bi bi-moon-stars-fill"></i> TH√àME
                    </button>
                </div>

                <hr class="border-secondary mb-4 opacity-25">

                <div class="mb-4 text-center">
                    <label class="form-label small text-uppercase ls-1">Mode de R√©v√©lation</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="gameMode" id="modeSecret" value="secret" checked onclick="SFX.click()">
                        <label class="btn btn-outline-custom" for="modeSecret">SECRET</label>
                        <input type="radio" class="btn-check" name="gameMode" id="modeRevele" value="revele" onclick="SFX.click()">
                        <label class="btn btn-outline-custom" for="modeRevele">R√âV√âL√â</label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label d-flex justify-content-between">
                        <span>Nombre de Joueurs</span>
                        <span id="displayPlayerCount" class="fw-bold text-info fs-5">4</span>
                    </label>
                    <input type="range" class="form-range" min="3" max="20" id="rangePlayers" value="4" oninput="updateConfigFromSlider(); SFX.click()">
                </div>

                <div class="row text-center g-2 mb-4">
                    <div class="col-4">
                        <div class="stat-box box-infiltre h-100">
                            <div class="role-name">Infiltr√©</div>
                            <div class="d-flex align-items-center gap-2">
                                <button class="ctrl-btn ctrl-minus" id="btnMinusInf" onclick="adjustRole('infiltre', -1); SFX.click()">-</button>
                                <div class="role-count" id="displayInfiltres">1</div>
                                <button class="ctrl-btn ctrl-plus" id="btnPlusInf" onclick="adjustRole('infiltre', 1); SFX.click()">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-box box-inconnu h-100">
                            <div class="role-name">Inconnu</div>
                            <div class="d-flex align-items-center gap-2">
                                <button class="ctrl-btn ctrl-minus" id="btnMinusInc" onclick="adjustRole('inconnu', -1); SFX.click()">-</button>
                                <div class="role-count" id="displayInconnus">0</div>
                                <button class="ctrl-btn ctrl-plus" id="btnPlusInc" onclick="adjustRole('inconnu', 1); SFX.click()">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-box box-pnj h-100">
                            <div class="role-name">PNJ</div>
                            <div class="role-count" id="displayPNJ" style="padding: 5px 0;">3</div>
                        </div>
                    </div>
                </div>

                <div class="form-check form-switch mb-4 d-flex justify-content-center gap-2 align-items-center">
                    <input class="form-check-input" type="checkbox" role="switch" id="optWakeLock" checked style="width: 50px; height: 25px; cursor: pointer;">
                    <label class="form-check-label small text-uppercase" for="optWakeLock">
                        <i class="bi bi-brightness-high"></i> √âcran allum√©
                    </label>
                </div>

                <button onclick="initGame(); SFX.success()" class="btn btn-neon w-100 py-3">INITIALISER LA MISSION</button>
            </div>
        </div>
    </div>

    <div id="view-roster" class="d-none row justify-content-center fade-in">
        <div class="col-md-6">
            <div class="glass-card p-4">
                <h4 class="mb-3 text-center brand-font text-info">BASE DE DONN√âES</h4>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="small text-muted text-uppercase">Agents Enregistr√©s</span>
                    <button onclick="resetSessionStats(); SFX.alarm()" class="btn btn-sm btn-outline-warning" style="font-size: 0.7rem;">
                        <i class="bi bi-arrow-counterclockwise"></i> RESET SESSION
                    </button>
                </div>

                <div id="roster-list-container" class="mb-4" style="max-height: 60vh; overflow-y: auto;">
                    </div>

                <button onclick="showView('view-setup'); SFX.click()" class="btn btn-secondary w-100">RETOUR MENU</button>
            </div>
        </div>
    </div>

    <div id="view-pass" class="d-none text-center fade-in pt-5">
        <div class="glass-card p-5 mx-auto" style="max-width: 500px;">
            <div id="pass-dynamic-content" class="mb-4">
                <i class="bi bi-phone-vibrate fs-1 text-muted mb-3 d-block"></i>
                <h3 class="mb-4">JOUEUR SUIVANT</h3>
            </div>
            
            <button onclick="handlePassClick(); SFX.click()" class="btn btn-neon w-100">JE SUIS PR√äT(E)</button>
        </div>
    </div>

    <div id="view-name" class="d-none text-center fade-in pt-4">
        <div class="glass-card p-4 mx-auto" style="max-width: 500px;">
            <h3 class="brand-font mb-4 text-info">IDENTIFICATION</h3>
            
            <div class="mb-4 position-relative d-inline-block">
                <div id="avatarPreview" class="rounded-circle border border-3 border-info d-flex justify-content-center align-items-center bg-dark" 
                     style="width: 120px; height: 120px; overflow: hidden; box-shadow: 0 0 20px rgba(56, 189, 248, 0.5);">
                    <i class="bi bi-person-fill fs-1 text-secondary"></i>
                </div>
                
                <label for="photoInput" class="position-absolute bottom-0 end-0 bg-warning text-dark rounded-circle d-flex justify-content-center align-items-center" 
                       style="width: 40px; height: 40px; cursor: pointer; border: 2px solid white; box-shadow: 0 0 10px #fbbf24;">
                    <i class="bi bi-camera-fill"></i>
                </label>
                <input type="file" id="photoInput" accept="image/*" capture="user" class="d-none" onchange="handlePhotoUpload(event)">
            </div>

            <div class="d-flex align-items-stretch gap-2 mb-4">
                <div class="cyber-input-group flex-grow-1">
                    <div class="cyber-label">PSEUDO</div>
                    <input type="text" class="cyber-input" id="inputPseudo" placeholder="Agent..." autocomplete="off">
                </div>
                <button class="btn btn-history" onclick="toggleHistoryModal(); SFX.click()" title="Joueurs pr√©c√©dents">
                    <i class="bi bi-person-lines-fill"></i>
                </button>
            </div>

            <button onclick="revealIdentity()" class="btn btn-neon w-100 py-3">R√âV√âLER MON CODE</button>
        </div>
    </div>

    <div id="view-reveal" class="d-none text-center fade-in">
        <div class="glass-card p-4 mx-auto" style="max-width: 500px;">
            <h2 id="revealTitle" class="brand-font mb-2">R√îLE</h2>
            <div class="p-4 border border-secondary rounded mb-4 bg-dark bg-opacity-10">
                <p class="text-muted small text-uppercase">Votre mot secret</p>
                <div id="revealWord" class="fs-1 fw-bold text-warning">MOT</div>
                <p id="revealDesc" class="small fst-italic mt-2">Description...</p>
            </div>
            <button onclick="nextPlayer(); SFX.click()" class="btn btn-outline-custom w-100 py-3" style="border:1px solid var(--text-main); color: var(--text-main)">J'AI M√âMORIS√â</button>
        </div>
    </div>

    <div id="view-pre-debate" class="d-none text-center fade-in pt-5">
        <div class="glass-card p-5 mx-auto" style="max-width: 600px;">
            <h2 class="mb-3">PR√äT AU D√âBAT ?</h2>
            <div class="alert alert-dark border border-secondary mb-5">
                Premier joueur √† parler :<br>
                <strong class="fs-3 text-info" id="firstPlayerName">---</strong>
            </div>
            <button onclick="startDebate(60); SFX.click()" class="btn btn-warning w-100 py-4 fw-bold fs-5 text-dark rounded-pill">
                üó£Ô∏è D√âBAT OUVERT (1 MIN)
            </button>
        </div>
    </div>

    <div id="view-debate" class="d-none text-center fade-in pt-3">
        <div class="glass-card p-4 mx-auto" style="max-width: 600px;">
            <p class="text-uppercase ls-2 text-muted mb-0">Temps Restant</p>
            <div id="timerDisplay" class="timer-display mb-2">02:00</div>
            <div id="timerBarBox" class="progress mb-4" style="height: 5px; background: rgba(125,125,125,0.2);">
                <div id="timerBar" class="progress-bar bg-info" style="width: 100%"></div>
            </div>
            <div id="timerStatus" class="text-info mb-4">D√©bat en cours...</div>
            <button onclick="forceVote(); SFX.click()" class="btn btn-stop w-100 mb-3">
                <i class="bi bi-stop-circle"></i> ARR√äTER & VOTER
            </button>
        </div>
    </div>

    <div id="view-vote" class="d-none fade-in pt-3">
        <div class="glass-card p-4 mx-auto" style="max-width: 600px;">
            <h3 class="text-center brand-font mb-4 text-danger">QUI √âLIMINER ?</h3>
            <p class="text-center text-muted mb-4">Touchez un nom pour le d√©signer.</p>
            <div id="voteButtonsContainer"></div>
        </div>
    </div>

    <div id="view-guess" class="d-none text-center fade-in pt-5">
        <div class="glass-card p-5 mx-auto" style="max-width: 500px;">
            <h3 class="brand-font text-warning mb-3">DERNI√àRE CHANCE !</h3>
            <p class="mb-4">Tu es l'Inconnu. Devine le mot des PNJ pour voler la victoire !</p>
            <input type="text" class="form-control text-center fs-4 mb-4" id="inputGuessWord" placeholder="Le mot secret..." autocomplete="off">
            <button onclick="validateGuess(); SFX.click()" class="btn btn-neon w-100 py-3">VALIDER</button>
        </div>
    </div>

    <div id="view-result" class="d-none text-center fade-in pt-5">
        <div class="glass-card p-5 mx-auto" style="max-width: 600px;">
            <h4 class="text-muted small text-uppercase">JOUEUR √âLIMIN√â</h4>
            
            <div id="eliminatedNameDisplay" class="fs-3 mb-2 fw-bold text-white-force">Pseudo</div>
            <div id="eliminatedRoleDisplay" class="eliminated-role">INFILTR√â</div>
            
            <hr class="border-secondary my-4">

            <div id="gameContinueAction">
                <p class="lead mb-4 text-muted">Personne n'a encore gagn√©...</p>
                <button onclick="setupNextRound(); SFX.click()" class="btn btn-neon w-100 py-3">
                    <i class="bi bi-arrow-clockwise"></i> PR√âPARER TOUR SUIVANT
                </button>
            </div>

            <div id="gameWinAction" class="d-none">
                <h2 id="winMessage" class="brand-font mb-4 victory-text">VICTOIRE</h2>
                
                <button onclick="toggleRevealEndModal(); SFX.click()" class="btn btn-warning w-100 py-3 mb-4 fw-bold text-dark rounded-pill">
                    <i class="bi bi-eye-fill"></i> VOIR LES MOTS SECRETS
                </button>

                <div class="row g-2">
                    <div class="col-6">
                        <button onclick="replayGame(); SFX.success()" class="btn btn-neon w-100 py-3 h-100" style="font-size: 0.9rem;">
                            <i class="bi bi-arrow-repeat d-block fs-4 mb-1"></i> REJOUER
                            <br><small class="fw-normal">M√™mes joueurs</small>
                        </button>
                    </div>
                    <div class="col-6">
                        <button onclick="location.reload()" class="btn btn-outline-danger w-100 py-3 h-100" style="font-size: 0.9rem;">
                            <i class="bi bi-house-fill d-block fs-4 mb-1"></i> MENU
                            <br><small class="fw-normal">Nouvelle partie</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-round-transition" class="d-none text-center fade-in pt-5">
        <div class="glass-card p-5 mx-auto" style="max-width: 600px;">
            <h2 class="mb-3 text-info">NOUVEAU TOUR</h2>
            <p class="mb-4">Redonnez un mot chacun votre tour.</p>
            <div class="alert alert-dark border border-secondary mb-5">
                C'est au tour de :<br>
                <strong class="fs-3 text-primary" id="nextRoundStarter">---</strong>
            </div>
            <button onclick="startDebate(60); SFX.click()" class="btn btn-warning w-100 py-4 fw-bold fs-5 text-dark rounded-pill">
                üó£Ô∏è LANCER LE CHRONO (1 Min)
            </button>
        </div>
    </div>

</div>

<div id="modal-history" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex justify-content-center align-items-center" style="z-index: 2000; backdrop-filter: blur(5px);">
    <div class="glass-card p-4 d-flex flex-column" style="width: 90%; max-width: 350px; max-height: 80vh;">
        <h4 class="brand-font mb-3 text-center">SELECTION RAPIDE</h4>
        <div class="history-scroll-container">
            <div id="history-list-container"></div>
        </div>
        <button onclick="toggleHistoryModal(); SFX.click()" class="btn btn-secondary w-100">FERMER</button>
    </div>
</div>

<div id="modal-reveal-end" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-90 d-flex justify-content-center align-items-center" style="z-index: 2050; backdrop-filter: blur(8px);">
    <div class="glass-card p-4 text-center" style="width: 90%; max-width: 400px; border: 1px solid var(--accent-neon);">
        <h3 class="brand-font mb-4 text-warning" style="letter-spacing: 2px;">D√âCLASSIFICATION</h3>
        <div class="row g-3 mb-4">
            <div class="col-6">
                <div class="p-3 rounded border border-info bg-dark bg-opacity-50 h-100 d-flex flex-column justify-content-center">
                    <small class="text-info brand-font mb-2">CIVILS</small>
                    <div id="endWordPNJ" class="fw-bold fs-5 text-break text-white">---</div>
                </div>
            </div>
            <div class="col-6">
                <div class="p-3 rounded border border-danger bg-dark bg-opacity-50 h-100 d-flex flex-column justify-content-center">
                    <small class="text-danger brand-font mb-2">INFILTR√âS</small>
                    <div id="endWordInf" class="fw-bold fs-5 text-break text-white">---</div>
                </div>
            </div>
        </div>
        <button onclick="toggleRevealEndModal(); SFX.click()" class="btn btn-outline-light w-100">FERMER</button>
    </div>
</div>

<div id="modal-quit-confirm" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-90 d-flex justify-content-center align-items-center" style="z-index: 3000; backdrop-filter: blur(8px);">
    <div class="glass-card p-4 text-center" style="width: 90%; max-width: 400px; border: 1px solid var(--danger-neon);">
        <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3"></i>
        <h4 class="brand-font mb-2">ABANDON DE MISSION ?</h4>
        <p class="text-muted mb-4">La partie en cours sera perdue.</p>
        <div class="d-flex gap-2">
            <button onclick="toggleQuitModal(); SFX.click()" class="btn btn-secondary w-50">ANNULER</button>
            <button onclick="confirmQuit(); SFX.error()" class="btn btn-danger w-50 fw-bold">QUITTER</button>
        </div>
    </div>
</div>

<script>
    // --- SOUND ENGINE (SFX) ---
    const SFX = {
        ctx: null,
        init: function() {
            if (!this.ctx) { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
            if (this.ctx.state === 'suspended') { this.ctx.resume(); }
        },
        playTone: function(freq, type, duration, vol = 0.1) {
            this.init();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.start(); osc.stop(this.ctx.currentTime + duration);
        },
        click: function() { this.playTone(800, 'sine', 0.1, 0.05); },
        error: function() { this.playTone(150, 'sawtooth', 0.3, 0.1); },
        success: function() { this.playTone(440, 'sine', 0.1, 0.1); setTimeout(() => this.playTone(880, 'sine', 0.2, 0.1), 100); },
        reveal: function() { this.playTone(300, 'square', 0.1, 0.05); setTimeout(() => this.playTone(600, 'square', 0.2, 0.05), 100); },
        alarm: function() { if(!this.ctx) this.init(); this.playTone(880, 'sine', 0.2, 0.2); setTimeout(() => this.playTone(880, 'sine', 0.2, 0.2), 300); setTimeout(() => this.playTone(440, 'triangle', 0.6, 0.3), 600); }
    };
    document.body.addEventListener('click', () => { SFX.init(); }, { once: true });
    document.getElementById('inputPseudo').addEventListener('keypress', function (e) { if (e.key === 'Enter') revealIdentity(); });
    document.getElementById('inputGuessWord').addEventListener('keypress', function (e) { if (e.key === 'Enter') { validateGuess(); SFX.click(); } });

    // --- DATA ---
    const wordPairs = [
        ["Pyramide", "Pharaon"], ["Guitare", "Violon"], ["Bi√®re", "Vin"],["McDo", "Burger King"], ["Facebook", "Twitter"], ["Plage", "Piscine"],
        ["Th√©", "Caf√©"], ["Lune", "Soleil"], ["Train", "M√©tro"], ["Chat", "Chien"],["PC", "Tablette"], ["Foot", "Rugby"], ["Netflix", "YouTube"], ["Batman", "Superman"],["Pain au Choc", "Croissant"], ["Ski", "Snowboard"], ["Ketchup", "Mayo"],["Android", "iPhone"], ["Chocolat", "Vanille"], ["Cinema", "Netflix"], ["Paris","Londres"], ["Rome","Ath√®nes"], ["Madrid","Barcelone"], ["Berlin","Amsterdam"], ["Lisbonne","Porto"], ["Mer","Oc√©an"], ["Lac","√âtang"], ["Rivi√®re","Fleuve"], ["Montagne","Colline"], ["For√™t","Jungle"], ["D√©sert","Savane"], ["Pluie","Neige"], ["Vent","Temp√™te"], ["Nuage","Brouillard"], ["Soleil","√âtoile"], ["Matin","Soir"], ["Jour","Nuit"], ["Printemps","Automne"], ["√ât√©","Hiver"], ["Chaud","Froid"], ["Feu","Glace"], ["Eau","Glace"], ["Vapeur","Fum√©e"], ["Or","Argent"], ["Cuivre","Fer"], ["Bois","M√©tal"], ["Verre","Plastique"], ["Pierre","Brique"], ["Mur","Cl√¥ture"], ["Porte","Fen√™tre"], ["Escalier","Ascenseur"], ["Maison","Appartement"], ["Villa","Chalet"], ["H√¥tel","Auberge"], ["√âcole","Universit√©"], ["Classe","Amphith√©√¢tre"], ["Livre","Magazine"], ["Journal","Blog"], ["Stylo","Crayon"], ["Feutre","Marqueur"], ["Gomme","Taille-crayon"], ["Table","Bureau"], ["Chaise","Fauteuil"], ["Canap√©","Lit"], ["Oreiller","Coussin"], ["Couette","Couverture"], ["R√©veil","Horloge"], ["Montre","Bracelet"], ["Bague","Collier"], ["Chapeau","Casquette"], ["Pull","Sweat"], ["Veste","Manteau"], ["Jean","Pantalon"], ["Short","Bermuda"], ["Robe","Jupe"], ["Chaussures","Baskets"], ["Bottes","Sandales"], ["Chaussettes","Collants"], ["√âcharpe","Foulard"], ["Gants","Moufles"], ["Parapluie","Imperm√©able"], ["Sac","Valise"], ["Cartable","Sac √† dos"], ["Cl√©","Serrure"], ["T√©l√©commande","Manette"], ["T√©l√©vision","√âcran"], ["Radio","Podcast"], ["Film","S√©rie"], ["Cin√©ma","Th√©√¢tre"], ["Acteur","R√©alisateur"], ["Chanteur","Musicien"], ["Groupe","Orchestre"], ["Piano","Clavier"], ["Batterie","Tambour"], ["Micro","Haut-parleur"], ["Casque","√âcouteurs"], ["Photo","Vid√©o"], ["Cam√©ra","Appareil photo"], ["Peinture","Dessin"], ["Crayon","Pinceau"], ["Couleur","Teinte"], ["Rouge","Rose"], ["Bleu","Vert"], ["Jaune","Orange"], ["Noir","Blanc"], ["Gris","Beige"], ["Clair","Sombre"], ["Rapide","Lent"], ["Fort","Faible"], ["Grand","Petit"], ["Large","√âtroit"], ["Lourd","L√©ger"], ["Plein","Vide"], ["Ouvert","Ferm√©"], ["Rond","Carr√©"], ["Triangle","Rectangle"], ["Nombre","Chiffre"], ["Addition","Soustraction"], ["Multiplication","Division"], ["Probl√®me","√ânigme"], ["Jeu","Jouet"], ["Puzzle","Casse-t√™te"], ["Cartes","Dominos"], ["√âchecs","Dames"], ["D√©s","Jetons"], ["Football","Basket"], ["Tennis","Badminton"], ["Golf","Mini-golf"], ["Natation","Plong√©e"], ["Course","Marathon"], ["Ski","Patinage"], ["V√©lo","Trottinette"], ["Moto","Scooter"], ["Voiture","Camion"], ["Bus","Tram"], ["Avion","H√©licopt√®re"], ["Bateau","Ferry"], ["Port","Marina"], ["Route","Autoroute"], ["Pont","Tunnel"], ["Feu rouge","Stop"], ["Carte","GPS"], ["Boussole","Carte"], ["Restaurant","Caf√©"], ["Bistrot","Brasserie"], ["Menu","Carte"], ["Entr√©e","Plat"], ["Plat","Dessert"], ["Fromage","Yaourt"], ["Lait","Cr√®me"], ["Beurre","Margarine"], ["Pain","Brioche"], ["Croissant","Pain au lait"], ["G√¢teau","Tarte"], ["Chocolat","Caramel"], ["Vanille","Fraise"], ["Pomme","Poire"], ["Banane","Mangue"], ["Orange","Cl√©mentine"], ["Citron","Pamplemousse"], ["Fraise","Framboise"], ["Raisin","Cerise"], ["Salade","Crudit√©s"], ["Tomate","Concombre"], ["Carotte","Betterave"], ["Oignon","√âchalote"], ["Ail","Gingembre"], ["Sel","Poivre"], ["Sucre","Miel"], ["√âpices","Herbes"], ["Caf√©","Expresso"], ["Th√©","Infusion"], ["Eau","Jus"], ["Soda","Limonade"], ["Bi√®re","Cidre"], ["Vin rouge","Vin blanc"], ["Champagne","Prosecco"], ["Bouteille","Canette"], ["Verre","Tasse"], ["Assiette","Bol"], ["Fourchette","Cuill√®re"], ["Couteau","Spatule"], ["Po√™le","Casserole"], ["Four","Micro-ondes"], ["Frigo","Cong√©lateur"], ["Cuisine","Salle √† manger"], ["Salon","S√©jour"], ["Salle de bain","Toilettes"], ["Douche","Baignoire"], ["Savon","Gel douche"], ["Shampoing","Apr√®s-shampoing"], ["Serviette","Peignoir"], ["Brosse","Peigne"], ["Dentifrice","Bain de bouche"], ["Parfum","D√©odorant"], ["Cr√®me","Lotion"], ["M√©decin","Infirmier"], ["H√¥pital","Clinique"], ["Pharmacie","Parapharmacie"], ["Maladie","Rhume"], ["Fi√®vre","Toux"], ["M√©dicament","Pilule"], ["Vaccin","Injection"], ["Sport","Exercice"], ["Yoga","Pilates"], ["Danse","Chor√©graphie"], ["Musique","Chanson"], ["Paroles","Refrain"], ["Couplet","Pont"], ["Silence","Calme"], ["Bruit","Vacarme"], ["Ville","Village"], ["Quartier","Centre-ville"], ["March√©","Supermarch√©"], ["Boutique","Magasin"], ["Caisse","Panier"], ["Ticket","Facture"], ["Prix","Tarif"], ["R√©duction","Promotion"], ["Cadeau","Surprise"], ["No√´l","Nouvel An"], ["Anniversaire","F√™te"], ["Mariage","Fian√ßailles"], ["Invit√©","H√¥te"], ["Famille","Cousins"], ["Parents","Enfants"], ["Fr√®re","S≈ìur"], ["Grand-p√®re","Grand-m√®re"], ["B√©b√©","Enfant"], ["Ami","Copain"], ["Voisin","Coll√®gue"], ["Patron","Employ√©"], ["Travail","Bureau"], ["R√©union","Conf√©rence"], ["Projet","Mission"], ["Objectif","But"], ["Succ√®s","Victoire"], ["√âchec","Erreur"], ["Chance","Hasard"], ["R√®gle","Loi"], ["Justice","Tribunal"], ["Police","Gendarmerie"], ["Pompiers","Ambulance"], ["Urgence","Secours"], ["Danger","Risque"], ["S√©curit√©","Protection"], ["Secret","Myst√®re"], ["Indice","Preuve"], ["Question","R√©ponse"], ["Probl√®me","Solution"], ["Id√©e","Concept"], ["Plan","Strat√©gie"], ["D√©but","Fin"], ["Avant","Apr√®s"], ["Toujours","Jamais"], ["Souvent","Parfois"], ["Vrai","Faux"], ["Oui","Non"],["Raclette", "Fondue"], 
        ["Mojito", "Spritz"],["Uber", "Taxi"],["Vinted", "LeBonCoin"],["T√©l√©travail", "Bureau"],["Climatisation", "Ventilateur"],["Barbecue", "Plancha"],["P√©tanque", "M√∂lkky"],["Koh-Lanta", "Fort Boyard"],["Ast√©rix", "Tintin"],["Pok√©mon", "Digimon"], 
        ["Zidane", "Mbapp√©"], ["Frites", "Potatoes"], ["Boxer", "Cale√ßon"], ["Barbe", "Moustache"], ["Tatouage", "Piercing"], ["Camping", "H√¥tel"], ["Influenceur", "Vedette"], ["Tacos", "Kebab"], ["Sushi", "Maki"], ["Vampire", "Loup-garou"], 
        ["Zombie", "Fant√¥me"], ["TikTok", "Instagram"], ["Emoji", "GIF"], ["Selfie", "Portrait"], ["Billard", "Baby-foot"], ["Piscine", "Jacuzzi"], ["Nutella", "Confiture"], ["Crocs", "Tongs"], ["Jul", "Ninho"],["Ascenseur", "Escalator"],   ["Aigle", "Faucon"], ["Tigre", "Lion"], ["Dauphin", "Requin"], ["Panda", "Ours"], ["Cheval", "√Çne"],
        ["Gu√™pe", "Abeille"], ["Papillon", "Libellule"], ["Araign√©e", "Scorpion"], ["Mouche", "Moustique"],
        ["Superman", "Spiderman"], ["Mario", "Luigi"], ["Harry Potter", "Frodon"], ["Yoda", "Gandalf"],
        ["Star Wars", "Star Trek"], ["Marvel", "DC Comics"], ["Naruto", "Dragon Ball"], ["Zelda", "Mario"],
        ["Pizza", "P√¢tes"], ["Sushi", "Ramen"], ["Burger", "Hot-dog"], ["Tacos", "Burrito"],
        ["Or", "Diamant"], ["Rubis", "Saphir"], ["Collier", "Bracelet"], ["Perle", "Bijou"],
        ["Snapchat", "TikTok"], ["Google", "Yahoo"], ["Windows", "MacOS"], ["Word", "Excel"],
        ["Guitare", "Basse"], ["Piano", "Orgue"], ["Trompette", "Saxophone"], ["Violon", "Violoncelle"],
        ["Paris", "Marseille"], ["New York", "Los Angeles"], ["Londres", "Dublin"], ["Tokyo", "S√©oul"],
        ["Tennis", "Ping-pong"], ["Rugby", "Football Am√©ricain"], ["Golf", "Hockey"], ["Boxe", "Judo"],
        ["Velo", "Moto"], ["Bus", "Car"], ["Scooter", "Trottinette"], ["Skate", "Roller"],
        ["Stylo", "Feutre"], ["Crayon", "Porte-mine"], ["Ciseaux", "Cutter"], ["R√®gle", "√âquerre"],
        ["Chaise", "Tabouret"], ["Canap√©", "Fauteuil"], ["Lit", "Hamac"], ["Tapis", "Moquette"],
        ["Pomme", "Poire"], ["Banane", "Ananas"], ["Melon", "Past√®que"], ["Citron", "Orange"], ["Tiime", "Pennylane"], ["Ivre", "Sobre"], ["Cr√©puscule", "Aurore"], ["Trump", "Poutine"], 
["Gay", "Lesbienne"], ["Chine", "Cor√©e"], ["Amende", "Prune"], 
["Disneyland", "Europa-Park"], ["Pauvre", "Riche"], ["Tombe", "Cercueil"], 
["Mariage", "Enterrement"], ["Photographie", "Peinture"], ["Architecte", "Ouvrier"], 
["Carnivore", "Herbivore"], ["Musculation", "Crossfit"],["Lego", "Playmobil"], ["Barbie", "Poup√©e"], ["Interstellar", "Avatar"], ["Zelda", "Link"], ["Pikachu", "Salam√®che"], ["Sith", "Jedi"], ["Hobbit", "Nain"], ["Elfe", "F√©e"], ["Dragon", "Dinosaure"], ["Viking", "Barbare"], ["Samoura√Ø", "Ninja"], ["Cowboy", "Indien"], ["Pirate", "Corsaire"], ["Robot", "Cyborg"], ["Alien", "Extraterrestre"], ["Matrix", "Inception"], ["Simpson", "South Park"], ["Friends", "How I Met Your Mother"], ["Monopoly", "La Bonne Paye"], ["Uno", "Monopoly"], ["Poker", "Blackjack"], ["Sudoku", "Mots fl√©ch√©s"], ["Mots crois√©s", "Scrabble"], ["Tetris", "Pac-Man"], ["PlayStation", "Xbox"], ["Discord", "Skype"], ["Waze", "Google Maps"], ["Spotify", "Deezer"], ["Wikipedia", "Dictionnaire"], ["Cr√™pe", "Gaufre"], ["Pancake", "Blini"], ["Donut", "Beignet"], ["Muffin", "Cupcake"], ["Baguette", "Ficelle"], ["Mie", "Cro√ªte"], ["Farine", "Levure"], ["Omelette", "≈íuf brouill√©"], ["Saucisson", "Chorizo"], ["Jambon", "Lardon"], ["P√¢t√©", "Rillettes"], ["Foie gras", "Mousse de canard"], ["Saumon", "Truite"], ["Thon", "Sardine"], ["Hu√Ætre", "Moule"], ["Crevette", "Gambas"], ["Homard", "Langouste"], ["Riz", "Semoule"], ["Lasagnes", "Gratin"], ["Pizza", "Calzone"], ["Kebab", "Shawarma"], ["Couscous", "Tajine"], ["Nem", "Samoussa"], ["Wasabi", "Moutarde"], ["Cornichon", "C√¢pre"], ["Olive verte", "Olive noire"], ["Vinaigre", "Huile"], ["Cacao", "Chocolat en poudre"], ["Nutella", "P√¢te √† tartiner"], ["Miel", "Sirop d'√©rable"],["Bougie", "Lampe"], ["Ampoule", "LED"], ["Allumette", "Briquet"], ["Cendre", "Poussi√®re"], ["Balai", "Aspirateur"], ["Serpilli√®re", "√âponge"], ["Seau", "Bassine"], ["Robinet", "Tuyau"], ["Vis", "Clou"], ["Marteau", "Maillet"], ["Tournevis", "Perceuse"], ["Scie", "Hache"], ["√âchelle", "Escabeau"], ["Toit", "Plafond"], ["Sol", "Plancher"], ["Tapis", "Paillasson"], ["Rideau", "Volet"], ["Drap", "Housse de couette"], ["Matelas", "Sommier"], ["Tiroir", "Placard"], ["Cintre", "Portemanteau"], ["Laine", "Coton"], ["Soie", "Velours"], ["Cuir", "Daim"], ["Bouton", "Fermeture √©clair"], ["Aiguille", "√âpingle"], ["Fil", "Corde"], ["Scotch", "Colle"], ["Carton", "Papier"], ["Enveloppe", "Timbre"],["Dent", "Molaire"], ["Langue", "Palais"], ["≈íil", "Pupille"], ["Cil", "Sourcil"], ["Cheveux", "Poils"], ["Main", "Poignet"], ["Doigt", "Pouce"], ["Ongle", "Griffe"], ["Coude", "Genou"], ["C≈ìur", "Poumon"], ["Sang", "Veine"], ["Os", "Squelette"], ["Cerveau", "Pens√©e"], ["Muscle", "Graisse"], ["Ride", "Bouton"], ["Lunettes", "Lentilles"], ["Rouge √† l√®vres", "Gloss"], ["Mascara", "Eye-liner"], ["Vernis", "Dissolvant"], ["Rasoir", "√âpilateur"], ["Savon", "Gel hydroalcoolique"], ["Mouchoir", "Serviette papier"], ["Pansement", "Bandage"], ["B√©quille", "Fauteuil roulant"], ["Thermom√®tre", "St√©thoscope"], ["Virus", "Bact√©rie"], ["Allergie", "Intol√©rance"], ["Sommeil", "Sieste"], ["R√™ve", "Cauchemar"], ["Ronflement", "Apn√©e"],["Lave", "Magma"], ["Volcan", "Crat√®re"], ["Tremblement de terre", "Tsunami"], ["Ouragan", "Tornade"], ["√âclair", "Tonnerre"], ["Arc-en-ciel", "Aurore bor√©ale"], ["Plan√®te", "Ast√©ro√Øde"], ["Galaxie", "Univers"], ["Atome", "Mol√©cule"], ["Feuille", "P√©tale"], ["Branche", "Tronc"], ["Racine", "Graine"], ["Herbe", "Pelouse"], ["Cactus", "Plante grasse"], ["Rose", "Tulipe"], ["Ch√™ne", "Sapin"], ["Champignon", "Truffe"], ["Loup", "Renard"],["Roi", "Empereur"], ["Reine", "Princesse"], ["Ch√¢teau", "Palais"], ["Prison", "Cachot"], ["Menottes", "Cha√Ænes"], ["Voleur", "Cambrioleur"], ["Assassin", "Tueur"], ["Arme", "Pistolet"], ["Guerre", "Bataille"], ["Paix", "Tr√™ve"], ["Drapeau", "Banni√®re"], ["Hymne", "Chant"], ["Vote", "√âlection"], ["Maire", "Pr√©sident"], ["Loi", "D√©cret"], ["Banque", "Coffre-fort"], ["Carte bleue", "Ch√©quier"], ["Monnaie", "Billet"], ["Or", "Lingot"], ["Diamant", "Cristal"], ["Histoire", "G√©ographie"], ["Maths", "Physique"], ["Chimie", "Biologie"], ["Fran√ßais", "Anglais"], ["Grammaire", "Orthographe"], ["Verbe", "Nom"], ["Pass√©", "Futur"], ["Hier", "Demain"], ["Maintenant", "Bient√¥t"], ["Amour", "Amiti√©"],["Passeport", "Visa"], ["Valise", "Sac de voyage"], ["Tente", "Caravane"], ["Camping-car", "Mobil-home"], ["Kayak", "Cano√´"], ["Radeau", "Barque"], ["Sous-marin", "Paquebot"], ["Montgolfi√®re", "Dirigeable"], ["Parachute", "Parapente"], ["Fus√©e", "Navette spatiale"], ["Tracteur", "Bulldozer"], ["Grue", "Pelle m√©canique"], ["Ambulance", "Corbillard"], ["Limousine", "Berline"], ["D√©capotable", "Cabriolet"], ["Essence", "Diesel"], ["Pneu", "Roue"], ["Volant", "Guidon"], ["Frein", "Acc√©l√©rateur"], ["Si√®ge", "Banquette"]
    ];

    // --- STATE ---
    let gameConfig = { total: 4, infiltres: 1, inconnus: 0, pnj: 3, mode: 'secret' };
    let rolesDeck = [];
    let players = [];
    let currentStep = 0;
    let timerInterval;
    let currentPNJWord = "";
    let currentInfiltreWord = "";
    let pendingVictimIndex = -1;
    let currentAvatarData = null;
    let previousStarters = [];

    // --- THEME ENGINE ---
    function initTheme() {
        const savedTheme = localStorage.getItem('intrusion_theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            updateThemeBtnIcon(true);
        } else {
            updateThemeBtnIcon(false);
        }
    }

    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        const isLight = document.body.classList.contains('light-mode');
        localStorage.setItem('intrusion_theme', isLight ? 'light' : 'dark');
        updateThemeBtnIcon(isLight);
    }

    function updateThemeBtnIcon(isLight) {
        const btn = document.getElementById('btnThemeToggle');
        if(isLight) btn.innerHTML = '<i class="bi bi-sun-fill"></i> CLAIR';
        else btn.innerHTML = '<i class="bi bi-moon-stars-fill"></i> SOMBRE';
    }
    
    // Init theme on load
    initTheme();

    // --- PHOTO & WAKE LOCK ---
    function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxSize = 300;
                let width = img.width; let height = img.height;
                if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } 
                else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                canvas.width = width; canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                currentAvatarData = canvas.toDataURL('image/jpeg', 0.7);
                document.getElementById('avatarPreview').innerHTML = `<img src="${currentAvatarData}" style="width:100%; height:100%; object-fit:cover;">`;
                SFX.click();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function resetPhotoInput() {
        currentAvatarData = null;
        document.getElementById('photoInput').value = ""; 
        document.getElementById('avatarPreview').innerHTML = '<i class="bi bi-person-fill fs-1 text-secondary"></i>';
    }

    let wakeLock = null;
    async function toggleScreenLock() {
        const isEnabled = document.getElementById('optWakeLock').checked;
        const video = document.getElementById('noSleepVideo');
        if (!isEnabled) {
            if (wakeLock !== null) { wakeLock.release().then(() => { wakeLock = null; }); }
            video.pause(); return;
        }
        try { if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); } } catch (err) {}
        try { video.play().catch(e => console.log(e)); } catch (e) {}
    }
    document.addEventListener('visibilitychange', async () => { if (document.visibilityState === 'visible') { await toggleScreenLock(); } });

    // --- PLAYER DATA & ROSTER ---
    function getStoredPlayers() {
        return JSON.parse(localStorage.getItem('intrusion_players_v3') || '[]');
    }

    function saveStoredPlayers(list) {
        localStorage.setItem('intrusion_players_v3', JSON.stringify(list));
    }

    function savePlayerToHistory(name) {
        if(!name) return;
        let history = getStoredPlayers();
        const existingIndex = history.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
        
        const playerData = {
            name: name,
            avatar: currentAvatarData || (existingIndex > -1 ? history[existingIndex].avatar : null),
            globalWins: existingIndex > -1 ? (history[existingIndex].globalWins || 0) : 0,
            sessionWins: existingIndex > -1 ? (history[existingIndex].sessionWins || 0) : 0
        };

        if (existingIndex > -1) history[existingIndex] = playerData;
        else history.unshift(playerData);

        if(history.length > 25) history.pop();
        saveStoredPlayers(history);
    }

    function removePlayerCompletely(name) {
        let history = getStoredPlayers();
        history = history.filter(p => p.name !== name);
        saveStoredPlayers(history);
        renderFullRoster(); // Refresh screen
    }

    function resetSessionStats() {
        let history = getStoredPlayers();
        history.forEach(p => p.sessionWins = 0);
        saveStoredPlayers(history);
        renderFullRoster();
    }

    function updateWinStats(winningRoles) {
        let history = getStoredPlayers();
        let updated = false;

        players.forEach(p => {
            let playerWon = false;
            if (winningRoles.includes('CIVILS') && p.role === 'PNJ') playerWon = true;
            if (winningRoles.includes('BAD') && (p.role === 'Infiltr√©' || p.role === 'Inconnu')) playerWon = true;
            if (winningRoles.includes('INCONNU_SOLO') && p.role === 'Inconnu') playerWon = true;
            
            if (playerWon) {
                const idx = history.findIndex(h => h.name.toLowerCase() === p.name.toLowerCase());
                if (idx > -1) {
                    history[idx].globalWins = (history[idx].globalWins || 0) + 1;
                    history[idx].sessionWins = (history[idx].sessionWins || 0) + 1;
                    updated = true;
                }
            }
        });
        
        if(updated) saveStoredPlayers(history);
    }

    // --- RENDER FULL ROSTER ---
    function renderFullRoster() {
        const list = document.getElementById('roster-list-container');
        const history = getStoredPlayers();
        list.innerHTML = '';
        
        if(history.length === 0) {
            list.innerHTML = '<p class="text-center text-muted fst-italic mt-4">Aucun agent dans la base.</p>';
        } else {
            history.forEach(player => {
                const item = document.createElement('div');
                item.className = 'roster-item';
                
                let avatarHtml = `<div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center" style="width: 50px; height: 50px;"><i class="bi bi-person-fill text-white"></i></div>`;
                if(player.avatar) avatarHtml = `<img src="${player.avatar}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">`;

                item.innerHTML = `
                    ${avatarHtml}
                    <div class="flex-grow-1">
                        <div class="fw-bold lh-1">${player.name}</div>
                        <div class="d-flex gap-2 mt-1">
                            <span class="stat-badge bg-primary text-white" title="Global"><i class="bi bi-trophy-fill"></i> ${player.globalWins||0}</span>
                            <span class="stat-badge bg-info text-white" title="Session"><i class="bi bi-calendar-event"></i> ${player.sessionWins||0}</span>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removePlayerCompletely('${player.name}'); SFX.error()"><i class="bi bi-trash"></i></button>
                `;
                list.appendChild(item);
            });
        }
    }

    // --- RENDER MINI HISTORY (Selection Rapide) ---
    function renderHistoryList() {
        const list = document.getElementById('history-list-container');
        const history = getStoredPlayers();
        list.innerHTML = '';
        if(history.length === 0) { list.innerHTML = '<p class="text-center text-muted">Vide</p>'; return; }
        
        history.forEach(player => {
            const item = document.createElement('div');
            item.className = 'history-item';
            let avatarHtml = `<div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center" style="width: 35px; height: 35px;"><i class="bi bi-person-fill text-white" style="font-size:0.8rem"></i></div>`;
            if(player.avatar) avatarHtml = `<img src="${player.avatar}" class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover;">`;

            item.innerHTML = `${avatarHtml} <span class="fw-bold small">${player.name}</span>`;
            item.onclick = () => {
                document.getElementById('inputPseudo').value = player.name;
                if(player.avatar) {
                    currentAvatarData = player.avatar;
                    document.getElementById('avatarPreview').innerHTML = `<img src="${currentAvatarData}" style="width:100%; height:100%; object-fit:cover;">`;
                } else resetPhotoInput();
                document.getElementById('modal-history').classList.add('d-none');
                SFX.click();
            };
            list.appendChild(item);
        });
    }

    function toggleHistoryModal() {
        const modal = document.getElementById('modal-history');
        if (modal.classList.contains('d-none')) { renderHistoryList(); modal.classList.remove('d-none'); } 
        else { modal.classList.add('d-none'); }
    }

    // --- UI HELPERS ---
    function showView(id) {
        // CORRECTION MAJEURE : S√©lectionne uniquement les DIV qui sont des VUES
        const currentView = document.querySelector('div[id^="view-"]:not(.d-none)');
        const nextView = document.getElementById(id);

        if (!currentView || currentView === nextView) {
            if(currentView) currentView.classList.add('d-none');
            nextView.classList.remove('d-none');
            nextView.classList.add('fade-in');
            
            if(id === 'view-setup' || id === 'view-roster') document.getElementById('btn-quit-app').classList.add('d-none');
            else document.getElementById('btn-quit-app').classList.remove('d-none');
            return;
        }

        currentView.classList.remove('fade-in');
        currentView.classList.add('fade-out');

        setTimeout(() => {
            currentView.classList.add('d-none');
            currentView.classList.remove('fade-out');
            nextView.classList.remove('d-none');
            nextView.classList.add('fade-in');
            
            if(id === 'view-setup' || id === 'view-roster') document.getElementById('btn-quit-app').classList.add('d-none');
            else document.getElementById('btn-quit-app').classList.remove('d-none');
            
        }, 280);
    }

    function toggleQuitModal() {
        const modal = document.getElementById('modal-quit-confirm');
        if(modal.classList.contains('d-none')) modal.classList.remove('d-none');
        else modal.classList.add('d-none');
    }
    function confirmQuit() { location.reload(); }

    // --- CONFIG LOGIC ---
    function updateConfigFromSlider() {
        const val = parseInt(document.getElementById('rangePlayers').value);
        gameConfig.total = val;
        document.getElementById('displayPlayerCount').innerText = val;
        let inf = 1, inc = 0;
        if (val >= 5 && val <= 6) { inf = 1; inc = 1; }
        else if (val >= 7 && val <= 8) { inf = 2; inc = 1; }
        else if (val >= 9 && val <= 10) { inf = 3; inc = 1; }
        else if (val >= 11 && val <= 12) { inf = 3; inc = 2; }
        else if (val >= 13 && val <= 14) { inf = 4; inc = 2; }
        else if (val >= 15 && val <= 16) { inf = 4; inc = 3; }
        else if (val >= 17 && val <= 18) { inf = 5; inc = 3; }
        else if (val >= 19) { inf = 5; inc = 4; }
        gameConfig.infiltres = inf; gameConfig.inconnus = inc;
        updateUIStats();
    }

    function adjustRole(role, delta) {
        const total = gameConfig.total;
        let inf = gameConfig.infiltres; let inc = gameConfig.inconnus;
        if (role === 'infiltre') {
            const newVal = inf + delta;
            if (newVal < 1) return;
            const badGuys = newVal + inc;
            if (badGuys < (total - badGuys)) gameConfig.infiltres = newVal;
        } else if (role === 'inconnu') {
            const newVal = inc + delta;
            if (newVal < 0) return;
            const badGuys = inf + newVal;
            if (badGuys < (total - badGuys)) gameConfig.inconnus = newVal;
        }
        updateUIStats();
    }

    function updateUIStats() {
        gameConfig.pnj = gameConfig.total - gameConfig.infiltres - gameConfig.inconnus;
        document.getElementById('displayInfiltres').innerText = gameConfig.infiltres;
        document.getElementById('displayInconnus').innerText = gameConfig.inconnus;
        document.getElementById('displayPNJ').innerText = gameConfig.pnj;
        const inf = gameConfig.infiltres; const inc = gameConfig.inconnus; const total = gameConfig.total;
        toggleBtn('btnMinusInf', inf <= 1); toggleBtn('btnMinusInc', inc <= 0);
        let nextBadInf = (inf + 1) + inc; toggleBtn('btnPlusInf', nextBadInf >= (total - nextBadInf));
        let nextBadInc = inf + (inc + 1); toggleBtn('btnPlusInc', nextBadInc >= (total - nextBadInc));
    }

    function toggleBtn(id, disabled) {
        const el = document.getElementById(id);
        if(disabled) el.classList.add('disabled'); else el.classList.remove('disabled');
    }
    updateConfigFromSlider();

    // --- LOGIC: SELECT SMART STARTER ---
    function pickSmartStarter(isFirstRound) {
        const alive = players.filter(p => p.alive);
        let candidates;
        
        // R√®gle 1 : Inconnu ne commence pas au round 1
        if (isFirstRound) {
            candidates = alive.filter(p => p.role !== 'Inconnu');
            if (candidates.length === 0) candidates = alive;
        } else {
            candidates = alive;
        }

        // R√®gle 2 : Priorit√© √† ceux qui n'ont jamais commenc√©
        let freshCandidates = candidates.filter(p => !previousStarters.includes(p.name));
        let chosenPlayer;

        if (freshCandidates.length > 0) {
            chosenPlayer = freshCandidates[Math.floor(Math.random() * freshCandidates.length)];
        } else {
            chosenPlayer = candidates[Math.floor(Math.random() * candidates.length)];
        }

        previousStarters.push(chosenPlayer.name);
        return chosenPlayer.name;
    }

    // --- PASS SCREEN LOGIC (Smart Button) ---
    function updatePassScreen() {
        const container = document.getElementById('pass-dynamic-content');
        const currentPlayer = players[currentStep];

        if (currentPlayer) {
            // MODE REPLAY
            let avatarHtml = `<div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center mx-auto mb-3" style="width: 100px; height: 100px; box-shadow: 0 0 15px var(--primary-neon);"><i class="bi bi-person-fill text-white fs-1"></i></div>`;
            if (currentPlayer.avatar) {
                avatarHtml = `<img src="${currentPlayer.avatar}" class="rounded-circle mx-auto mb-3" style="width: 100px; height: 100px; object-fit: cover; box-shadow: 0 0 15px var(--primary-neon); display:block;">`;
            }
            container.innerHTML = `
                ${avatarHtml}
                <h4 class="text-muted small text-uppercase mb-2">C'est au tour de</h4>
                <h2 class="brand-font text-info mb-4">${currentPlayer.name}</h2>
            `;
        } else {
            // MODE NORMAL
            container.innerHTML = `
                <i class="bi bi-phone-vibrate fs-1 text-muted mb-3 d-block"></i>
                <h3 class="mb-4">JOUEUR SUIVANT</h3>
            `;
        }
    }

    function handlePassClick() {
        const currentPlayer = players[currentStep];
        if (currentPlayer) {
            // REPLAY: Go straight to reveal
            const title = document.getElementById('revealTitle');
            const word = document.getElementById('revealWord');
            const desc = document.getElementById('revealDesc');
            
            if(currentPlayer.role === 'Inconnu') {
                title.innerText = "L'INCONNU"; title.style.color = '#adb5bd';
                word.innerText = "???"; word.style.color = '#adb5bd'; desc.innerText = "Tu n'as pas de mot. Bluffe !";
            } else {
                word.innerText = currentPlayer.word; word.style.color = '#fbbf24';
                if(gameConfig.mode === 'revele') {
                    if(currentPlayer.role === 'PNJ') { title.innerText = "PNJ"; title.style.color = '#38bdf8'; desc.innerText = "Tu es civil. Trouve l'intrus."; } 
                    else { title.innerText = "INFILTR√â"; title.style.color = '#f43f5e'; desc.innerText = "Tu es l'intrus. Cache-toi."; }
                } else {
                    title.innerText = "AGENT"; title.style.color = '#fff'; desc.innerText = "Analyse les autres mots.";
                }
            }
            SFX.reveal();
            showView('view-reveal');
        } else {
            // NEW GAME: Go to name input
            showNameInput();
        }
    }

    // --- GAME INIT ---
    function initGame() {
        toggleScreenLock();
        previousStarters = []; 
        gameConfig.mode = document.getElementById('modeRevele').checked ? 'revele' : 'secret';
        const pair = wordPairs[Math.floor(Math.random() * wordPairs.length)];
        currentPNJWord = pair[0]; currentInfiltreWord = pair[1];
        rolesDeck = [];
        for(let i=0; i<gameConfig.infiltres; i++) rolesDeck.push({role:'Infiltr√©', word:pair[1]});
        for(let i=0; i<gameConfig.inconnus; i++) rolesDeck.push({role:'Inconnu', word:null});
        for(let i=0; i<gameConfig.pnj; i++) rolesDeck.push({role:'PNJ', word:pair[0]});
        for (let i = rolesDeck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [rolesDeck[i], rolesDeck[j]] = [rolesDeck[j], rolesDeck[i]]; }
        players = []; 
        currentStep = 0; 
        updatePassScreen();
        showView('view-pass');
    }
    
    // --- REPLAY GAME (SAME PLAYERS) ---
    function replayGame() {
        const oldPlayers = players.map(p => ({ name: p.name, avatar: p.avatar }));
        previousStarters = []; 
        
        const pair = wordPairs[Math.floor(Math.random() * wordPairs.length)];
        currentPNJWord = pair[0]; currentInfiltreWord = pair[1];
        
        rolesDeck = [];
        for(let i=0; i<gameConfig.infiltres; i++) rolesDeck.push({role:'Infiltr√©', word:pair[1]});
        for(let i=0; i<gameConfig.inconnus; i++) rolesDeck.push({role:'Inconnu', word:null});
        for(let i=0; i<gameConfig.pnj; i++) rolesDeck.push({role:'PNJ', word:pair[0]});
        
        for (let i = rolesDeck.length - 1; i > 0; i--) { 
            const j = Math.floor(Math.random() * (i + 1)); 
            [rolesDeck[i], rolesDeck[j]] = [rolesDeck[j], rolesDeck[i]]; 
        }

        players = [];
        for(let i=0; i < oldPlayers.length; i++) {
            if(i < rolesDeck.length) {
                players.push({
                    name: oldPlayers[i].name,
                    avatar: oldPlayers[i].avatar,
                    role: rolesDeck[i].role,
                    word: rolesDeck[i].word,
                    alive: true
                });
            }
        }
        currentStep = 0;
        updatePassScreen();
        showView('view-pass');
    }

    // --- SETUP LOOP ---
    function showNameInput() { resetPhotoInput(); document.getElementById('inputPseudo').value = ""; showView('view-name'); setTimeout(() => document.getElementById('inputPseudo').focus(), 100); }

    function revealIdentity() {
        const inputVal = document.getElementById('inputPseudo').value.trim();
        const pseudo = inputVal || ("Joueur " + (currentStep + 1));
        
        const isTaken = players.some(p => p.name.toLowerCase() === pseudo.toLowerCase());
        if (isTaken) { alert("Ce pseudo est d√©j√† pris !"); SFX.error(); return; }
        
        if(inputVal) savePlayerToHistory(inputVal);

        const data = rolesDeck[currentStep];
        players.push({ name: pseudo, role: data.role, word: data.word, alive: true, avatar: currentAvatarData });

        const title = document.getElementById('revealTitle');
        const word = document.getElementById('revealWord');
        const desc = document.getElementById('revealDesc');

        if(data.role === 'Inconnu') {
            title.innerText = "L'INCONNU"; title.style.color = '#adb5bd';
            word.innerText = "???"; word.style.color = '#adb5bd'; desc.innerText = "Tu n'as pas de mot. Bluffe !";
        } else {
            word.innerText = data.word; word.style.color = '#fbbf24';
            if(gameConfig.mode === 'revele') {
                if(data.role === 'PNJ') { title.innerText = "PNJ"; title.style.color = '#38bdf8'; desc.innerText = "Tu es civil. Trouve l'intrus."; } 
                else { title.innerText = "INFILTR√â"; title.style.color = '#f43f5e'; desc.innerText = "Tu es l'intrus. Cache-toi."; }
            } else {
                title.innerText = "AGENT"; title.style.color = '#fff'; desc.innerText = "Analyse les autres mots.";
            }
        }
        SFX.reveal(); showView('view-reveal');
    }

    function nextPlayer() {
        currentStep++;
        if(currentStep < gameConfig.total) {
            updatePassScreen();
            showView('view-pass');
        }
        else { 
            // FIRST ROUND: TRUE to protect Inconnu
            const starterName = pickSmartStarter(true);
            document.getElementById('firstPlayerName').innerText = starterName; 
            showView('view-pre-debate'); 
        }
    }

    // --- GAME LOOP ---
    function startDebate(seconds) {
        showView('view-debate');
        let timeLeft = seconds;
        const display = document.getElementById('timerDisplay');
        const bar = document.getElementById('timerBar');
        const status = document.getElementById('timerStatus');
        display.classList.remove('text-danger'); display.classList.remove('timer-urgent'); 
        bar.classList.remove('bg-danger'); bar.classList.add('bg-info'); status.innerText = "D√©bat en cours...";
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft/60); let s = timeLeft%60;
            display.innerText = (m<10?"0"+m:m) + ":" + (s<10?"0"+s:s);
            bar.style.width = ((timeLeft/seconds)*100) + "%";
            if(timeLeft <= 10) { display.classList.add('text-danger'); display.classList.add('timer-urgent'); bar.classList.remove('bg-info'); bar.classList.add('bg-danger'); }
            if(timeLeft <= 0) { forceVote(); }
        }, 1000);
    }
    function forceVote() { clearInterval(timerInterval); SFX.alarm(); setupVoteScreen(); }

    // --- VOTE ---
    function setupVoteScreen() {
        showView('view-vote');
        const container = document.getElementById('voteButtonsContainer');
        container.innerHTML = "";
        players.forEach((p, index) => {
            if(p.alive) {
                const btn = document.createElement('div');
                btn.className = "btn-vote p-2 mb-3 d-flex align-items-center gap-3 border border-secondary rounded bg-dark bg-opacity-25";
                btn.style.cursor = "pointer";
                btn.onclick = () => { handleVoteClick(index); SFX.click(); };
                let avatarHtml = `<div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center" style="width: 50px; height: 50px;"><i class="bi bi-person-fill text-white"></i></div>`;
                if (p.avatar) avatarHtml = `<img src="${p.avatar}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">`;
                btn.innerHTML = `${avatarHtml}<div class="flex-grow-1 text-start"><div class="fw-bold fs-5 text-white-force">${p.name}</div></div><i class="bi bi-crosshair fs-3 text-danger"></i>`;
                container.appendChild(btn);
            }
        });
    }

    function handleVoteClick(index) {
        const victim = players[index];
        pendingVictimIndex = index;
        if (victim.role === 'Inconnu') { document.getElementById('inputGuessWord').value = ""; showView('view-guess'); } 
        else { finalizeElimination(index); }
    }

    // --- ALGO ---
    function cleanString(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim(); }
    function levenshtein(a, b) {
        if (a.length === 0) return b.length; if (b.length === 0) return a.length;
        const matrix = []; for (let i = 0; i <= b.length; i++) matrix[i] = [i]; for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= b.length; i++) { for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) { matrix[i][j] = matrix[i - 1][j - 1]; } 
                else { matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)); }
        }} return matrix[b.length][a.length];
    }

    function validateGuess() {
        const guessRaw = document.getElementById('inputGuessWord').value;
        const guess = cleanString(guessRaw); const correct = cleanString(currentPNJWord);
        let isCorrect = false; if (guess === correct) isCorrect = true; else { const dist = levenshtein(guess, correct); if (dist <= 1) isCorrect = true; }
        players[pendingVictimIndex].alive = false;
        
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        document.body.classList.add('elimination-shock');
        setTimeout(() => document.body.classList.remove('elimination-shock'), 500);

        if (isCorrect) {
            SFX.success(); showView('view-result');
            document.getElementById('gameContinueAction').classList.add('d-none'); document.getElementById('gameWinAction').classList.remove('d-none');
            const winMsg = document.getElementById('winMessage');
            document.getElementById('eliminatedNameDisplay').innerText = players[pendingVictimIndex].name;
            document.getElementById('eliminatedRoleDisplay').innerText = "INCONNU"; document.getElementById('eliminatedRoleDisplay').style.color = "#94a3b8";
            updateWinStats(['INCONNU_SOLO']);
            winMsg.innerText = "VICTOIRE DE L'INCONNU !"; winMsg.className = "brand-font mb-4 victory-text text-white-force";
            updateEliminatedImage();
        } else { SFX.error(); finalizeElimination(pendingVictimIndex); }
    }

    function finalizeElimination(index) {
        const victim = players[index];
        victim.alive = false;
        
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        document.body.classList.add('elimination-shock');
        setTimeout(() => document.body.classList.remove('elimination-shock'), 500);

        showView('view-result');
        const roleDisplay = document.getElementById('eliminatedRoleDisplay');
        const nameDisplay = document.getElementById('eliminatedNameDisplay');
        nameDisplay.innerText = victim.name;
        roleDisplay.innerText = victim.role.toUpperCase();
        if(victim.role === 'PNJ') roleDisplay.style.color = '#38bdf8'; else if(victim.role === 'Infiltr√©') roleDisplay.style.color = '#f43f5e'; else roleDisplay.style.color = '#94a3b8';
        updateEliminatedImage();
        checkWinCondition();
    }

    function updateEliminatedImage() {
        const victim = players[pendingVictimIndex];
        const oldImg = document.getElementById('eliminatedImage'); if(oldImg) oldImg.remove();
        if (victim.avatar) {
            const nameDisplay = document.getElementById('eliminatedNameDisplay');
            const imgContainer = document.createElement('div');
            imgContainer.id = 'eliminatedImage';
            imgContainer.className = "mb-3 mx-auto rounded-circle border border-4 border-danger shadow-lg";
            imgContainer.style.width = "150px"; imgContainer.style.height = "150px"; imgContainer.style.overflow = "hidden";
            imgContainer.innerHTML = `<img src="${victim.avatar}" style="width: 100%; height: 100%; object-fit: cover;">`;
            nameDisplay.parentNode.insertBefore(imgContainer, nameDisplay);
        }
    }

    function checkWinCondition() {
        const pnjAlive = players.filter(p => p.alive && p.role === 'PNJ').length;
        const infiltresAlive = players.filter(p => p.alive && p.role === 'Infiltr√©').length;
        const inconnuAlive = players.filter(p => p.alive && p.role === 'Inconnu').length;
        const totalBadGuys = infiltresAlive + inconnuAlive; const totalOthers = pnjAlive + infiltresAlive;
        const continueDiv = document.getElementById('gameContinueAction');
        const winDiv = document.getElementById('gameWinAction');
        const winMsg = document.getElementById('winMessage');
        continueDiv.classList.remove('d-none'); winDiv.classList.add('d-none');

        if(totalBadGuys === 0) {
            SFX.success(); continueDiv.classList.add('d-none'); winDiv.classList.remove('d-none');
            winMsg.innerText = "VICTOIRE DES CIVILS !"; winMsg.className = "brand-font mb-4 victory-text text-info";
            updateWinStats(['CIVILS']);
        }
        else if(inconnuAlive > 0 && totalOthers <= 1) {
            SFX.success(); continueDiv.classList.add('d-none'); winDiv.classList.remove('d-none');
            winMsg.innerText = "VICTOIRE DE L'INCONNU !"; winMsg.className = "brand-font mb-4 victory-text text-white-force";
            updateWinStats(['INCONNU_SOLO']);
        }
        else if(infiltresAlive >= pnjAlive) {
            SFX.success(); continueDiv.classList.add('d-none'); winDiv.classList.remove('d-none');
            winMsg.innerText = "VICTOIRE DES INFILTR√âS !"; winMsg.className = "brand-font mb-4 victory-text text-danger";
            updateWinStats(['BAD']);
        }
    }

    function setupNextRound() {
        // NEXT ROUND: FALSE because Inconnu can now start
        const starterName = pickSmartStarter(false);
        document.getElementById('nextRoundStarter').innerText = starterName;
        showView('view-round-transition');
    }

    function toggleRevealEndModal() {
        const modal = document.getElementById('modal-reveal-end');
        document.getElementById('endWordPNJ').innerText = currentPNJWord;
        document.getElementById('endWordInf').innerText = currentInfiltreWord;
        if (modal.classList.contains('d-none')) { modal.classList.remove('d-none'); SFX.reveal(); } else { modal.classList.add('d-none'); }
    }
</script>
</body>
</html>